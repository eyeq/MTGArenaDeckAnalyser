<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <title>MTG Arena Deck Analyser</title>

    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>

    <link rel="stylesheet" href="https://fonts.sandbox.google.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

    <style>
        #board {
            max-width: 1120px;
        }
        #board[style*="width"] {
            max-width: unset;
        }
    </style>
</head>

<body>
    <header>
        <h1>MTG Arena Deck Analyser</h1>
    </header>

    <div style="display: inline-block; vertical-align: top; width: 480px;">
        <h2 style="margin-bottom: 0;">Input</h2>
        <div style="display: inline-block; vertical-align: top; margin: 8px;">
            <textarea id="input" style="width: 400px; height: 240px;" placeholder="Export a Deck from MTG Arena" onchange="read();"></textarea>
        </div>
    </div>

    <div style="display: inline-block; vertical-align: top; width: 640px;">
        <h2 style="margin-bottom: 0;">Share this deck</h2>
        <div style="display: inline-block; vertical-align: top; margin: 8px;">
            <div id="link"></div>
        </div>
    </div>

    <h2 style="margin-bottom: 0;">Output</h2>
    <div style="display: inline-block; vertical-align: top; width: 480px;">
        <div style="display: inline-block; vertical-align: top; margin: 8px;">
            <h3>Main Set</h3>
            <div id="set"></div>
        </div>
        <div style="display: inline-block; vertical-align: top; margin: 8px;">
            <h3>Format</h3>
            <div id="format"></div>
        </div>
    </div>

    <div style="display: inline-block; vertical-align: top; width: 662px;">
        <div style="display: inline-block; vertical-align: top; margin: 8px;">
            <h3>Color</h3>
            <div id="color"></div>
            <br>
            <table>
                <tr>
                    <th>Mana Symbol</th>
                </tr>
                <tr>
                    <td>
                        <div id="symbol"></div>
                    </td>
                </tr>
            </table>
        </div>
        <div style="display: inline-block; vertical-align: top; margin: 8px;">
            <h3>Archetype</h3>
            <div id="decktype"></div>
            <br>
            <table>
                <tr>
                    <th style="width: 90px;">Keycard</th>
                    <th style="width: 90px;">Subtype</th>
                    <th style="width: 90px;">Keyword</th>
                    <th style="width: 90px;">Type</th>
                </tr>
                <tr>
                    <td>
                        <div id="keycard"></div>
                    </td>
                    <td>
                        <div id="subtype"></div>
                    </td>
                    <td>
                        <div id="keyword"></div>
                    </td>
                    <td>
                        <div id="archetype"></div>
                    </td>
                </tr>
            </table>
        </div>
    </div>
    <br>

    <h3 style="margin-bottom: 0;">Main</h3>
    <div style="display: inline-block; vertical-align: top; width: 480px;">
        <div style="display: inline-block; vertical-align: top; margin: 8px;">
            <h4>Rarity</h4>
            <div id="rarity_main"></div>
        </div>
        <div style="display: inline-block; vertical-align: top; margin: 8px;">
            <h4>Card Type</h4>
            <div id="type_main"></div>
        </div>
    </div>

    <div style="display: inline-block; vertical-align: top; width: 662px;">
        <div style="display: inline-block; vertical-align: top; margin: 8px;">
            <h4>Mana Curve</h4>
            <div id="cmc_main"></div>
        </div>
    </div>
    <br>

    <h3 style="margin-bottom: 0;">Sideboard</h3>
    <div style="display: inline-block; vertical-align: top; width: 480px;">
        <div style="display: inline-block; vertical-align: top; margin: 8px;">
            <h4>Rarity</h4>
            <div id="rarity_side"></div>
        </div>
        <div style="display: inline-block; vertical-align: top; margin: 8px;">
            <h4>Card Type</h4>
            <div id="type_side"></div>
        </div>
    </div>

    <div style="display: inline-block; vertical-align: top; width: 662px;">
        <div style="display: inline-block; vertical-align: top; margin: 8px;">
            <h4>Mana Curve</h4>
            <div id="cmc_side"></div>
        </div>
    </div>

    <h3>Image</h3>
    <div style="display: inline-block; vertical-align: top; margin: 8px;">
        <input type="radio" id="t" name="size" value="t">
        <label for="t">Tiny</label>

        <input type="radio" id="s" name="size" value="s" checked>
        <label for="s">Small</label>

        <input type="radio" id="m" name="size" value="m">
        <label for="m">Medium</label>

        <input type="radio" id="l" name="size" value="l">
        <label for="l">Large</label>

        <input type="radio" id="h" name="size" value="h">
        <label for="h">Huge</label>
    </div>
    <br>

    <div style="display: inline-block; vertical-align: top; margin: 8px;">
        <div id="board" style="resize: horizontal; overflow: hidden;"></div>
    </div>
    <br>
    <br>

    <footer style="padding: 16px; background: #f9f9fb;">
        <p>Using "Magic: The Gathering API(api.magicthegathering.io)".</p>
        <p>Thanks for <a href="https://magicthegathering.io/">MTG Developers</a> and <a href="https://mtgjson.com/">MTGJSON</a>.</p>
    </footer>

    <script>
        (() => {
            let url = new URL(location.href);
            let searchParams = url.searchParams;

            let input = searchParams.get('input');
            if (input) {
                let val = '';
                input.split('_').forEach((d, i) => {
                    val += d;
                    if (i % 3 === 2) {
                        val += '\n';
                    } else {
                        val += ' ';
                    }
                });
                let text = $('#input').val(val);
                read();
            }

            $('input[name="size"]').on('change', resizeImage);
        })();

        function resizeImage() {
            let img = $('#board img');

            let val = $('input:radio[name="size"]:checked').val();
            switch (val) {
                case 't':
                    img.prop('width', '106');
                    img.prop('height', '148');
                    break;
                case 's':
                    img.prop('width', '159');
                    img.prop('height', '222');
                    break;
                case 'm':
                    img.prop('width', '212');
                    img.prop('height', '296');
                    break;
                case 'l':
                    img.prop('width', '265');
                    img.prop('height', '370');
                    break;
                case 'h':
                    img.prop('width', '530');
                    img.prop('height', '740');
                    break;
            }
        }

        function read() {
            let text = $('#input').val().trim();
            text = text.replace(/\r\n|\r/g, '\n');

            let counts = [];
            let promises = [];

            let commander = false;
            let sideboard = -1;
            let empty_row = [];
            let link = location.pathname + '?input=';
            text.split('\n').forEach(d => {
                d = d.trim();
                if (d === '') {
                    empty_row.push(counts.length);
                }
                if (d === 'Commander') {
                    commander = true;
                }

                let s = d.split(' ');
                if (s.length >= 3) {
                    let count = Number(s[0]);
                    let set = s[s.length - 2].replace(/[()]/g, '');
                    let number = s[s.length - 1];

                    counts.push(count);
                    promises.push(send(set, number));

                    link += count + '_' + set + '_' + number + '_';
                } else {
                    if (d !== 'Commander') {
                        sideboard = counts.length;
                    }

                    link += d + '___';
                }
            });
            $('#link').html('<a href="' + link + '">Copy link address</a>');

            let counts_sum = counts.reduce((p, v) => p + v, 0);
            Promise.all(promises).then((data) => {
                console.log(data);

                // fix api.magicthegathering.io
                data.forEach((d, i) => {
                    if (d.length === 0) {
                        return;
                    }
                    d.forEach(d => {
                        d.color = d.color || [];
                        d.colorIdentity = d.colorIdentity || [];
                        d.manaCost = d.manaCost || '';

                        d.types = d.types || [];
                        d.supertypes = d.supertypes || [];
                        d.subtypes = d.subtypes || [];
                    });

                    if (d.length > 1 && d[0].layout === 'modal_dfc') {
                        if (d[0].imageUrl === d[1].imageUrl) {
                            let url = new URL(d[1].imageUrl);
                            let searchParams = url.searchParams;

                            let id = searchParams.get('multiverseid');
                            searchParams.set('multiverseid', Number(id) + 1);
                            url.search = searchParams.toString();

                            d[1].imageUrl = url.href;
                        }
                    }
                });

                // color / symbol
                {
                    let symbols = {
                        C: 0,
                        W: 0,
                        U: 0,
                        B: 0,
                        R: 0,
                        G: 0,
                        P: 0,
                        S: 0,
                    };
                    let keys = Object.keys(symbols);
                    data.forEach((d, i) => {
                        if (d.length === 0) {
                            return;
                        }
                        let count = counts[i];

                        keys.forEach(key => {
                            if (!d[0].types.includes('Land')) {
                                symbols[key] += (d[0].manaCost.split(key).length - 1) * count;
                            }

                            if (d.length > 1) {
                                if (d[0].layout !== 'transform') {
                                    if (!d[1].types.includes('Land')) {
                                        symbols[key] += (d[1].manaCost.split(key).length - 1) * count;
                                    }
                                }
                            }
                        });
                    });
                    symbols.sum = symbols.W + symbols.U + symbols.B + symbols.G + symbols.R;
                    console.log(symbols);
                    if (symbols.C + symbols.W + symbols.U + symbols.B + symbols.R + symbols.G === 0) {
                        symbols.C = 1;
                    }

                    // symbol
                    $('#symbol').html('<canvas></canvas>');
                    let canvas = $('#symbol canvas')[0];
                    canvas.width = 80;
                    canvas.height = 80;

                    new Chart(canvas, {
                        type: 'pie',
                        data: {
                            labels: ['C', 'W', 'U', 'B', 'R', 'G'],
                            datasets: [
                                {
                                    data: [symbols.C, symbols.W, symbols.U, symbols.B, symbols.R, symbols.G],
                                    backgroundColor: ['#E0E0E0', '#FFFDDB', '#C8E0F7', '#D0C7C0', '#E5B08F', '#B7D9B5'],
                                    borderColor: ['#000000', '#000000', '#000000', '#000000', '#000000', '#000000'],
                                },
                            ],
                        },
                        options: {
                            responsive: false,
                            plugins: {
                                legend: false,
                                tooltip: false,
                            },
                        },
                    });

                    // color
                    let colors = [];
                    if (symbols.W / symbols.sum >= 0.12) {
                        colors.push('White');
                    }
                    if (symbols.U / symbols.sum >= 0.12) {
                        colors.push('Blue');
                    }
                    if (symbols.B / symbols.sum >= 0.12) {
                        colors.push('Black');
                    }
                    if (symbols.R / symbols.sum >= 0.12) {
                        colors.push('Red');
                    }
                    if (symbols.G / symbols.sum >= 0.12) {
                        colors.push('Green');
                    }
                    switch (colors.length) {
                        case 0:
                            $('#color').html('Colorless');
                            break;
                        case 1:
                            $('#color').html('Mono ' + colors[0]);
                            break;
                        case 5:
                            $('#color').html('5-color');
                            break;
                        default:
                            $('#color').html(colors.join(' '));
                            break;
                    }
                }

                // cmc
                {
                    let keys = ['Colorless', 'White', 'Blue', 'Black', 'Red', 'Green', 'Multicolored'];
                    let colors_main = {};
                    let colors_side = {};
                    keys.forEach(d => {
                        colors_main[d] = {
                            cmc_l: 0,
                            cmc_0: 0,
                            cmc_1: 0,
                            cmc_2: 0,
                            cmc_3: 0,
                            cmc_4: 0,
                            cmc_5: 0,
                            cmc_6: 0,
                            cmc_7: 0,
                            cmc_x: 0,
                        };
                        colors_side[d] = {
                            cmc_l: 0,
                            cmc_0: 0,
                            cmc_1: 0,
                            cmc_2: 0,
                            cmc_3: 0,
                            cmc_4: 0,
                            cmc_5: 0,
                            cmc_6: 0,
                            cmc_7: 0,
                            cmc_x: 0,
                        };
                    });
                    let getColorKey = (colorIdentity) => {
                        switch (colorIdentity.length) {
                            case 0:
                                return 'Colorless';
                            case 1:
                                switch (colorIdentity[0]) {
                                    case 'W':
                                        return 'White';
                                    case 'U':
                                        return 'Blue';
                                    case 'B':
                                        return 'Black';
                                    case 'R':
                                        return 'Red';
                                    case 'G':
                                        return 'Green';
                                }
                                break;
                            default:
                                return 'Multicolored';
                        }
                    };
                    let addColorsCount = (colors, d, count) => {
                        let color_key = getColorKey(d.colorIdentity);

                        if (d.types.includes('Land')) {
                            colors[color_key].cmc_l += count;
                        } else if (d.manaCost.includes('{X}')) {
                            colors[color_key].cmc_x += count;
                        } else {
                            switch (d.cmc) {
                                case 0:
                                    colors[color_key].cmc_0 += count;
                                    break;
                                case 1:
                                    colors[color_key].cmc_1 += count;
                                    break;
                                case 2:
                                    colors[color_key].cmc_2 += count;
                                    break;
                                case 3:
                                    colors[color_key].cmc_3 += count;
                                    break;
                                case 4:
                                    colors[color_key].cmc_4 += count;
                                    break;
                                case 5:
                                    colors[color_key].cmc_5 += count;
                                    break;
                                case 6:
                                    colors[color_key].cmc_6 += count;
                                    break;
                                default:
                                    colors[color_key].cmc_7 += count;
                                    break;
                            }
                        }
                    };
                    data.forEach((d, i) => {
                        if (d.length === 0) {
                            return;
                        }
                        let count = counts[i];

                        if (sideboard === -1 || i <= sideboard) {
                            addColorsCount(colors_main, d[0], count);
                            if (d.length > 1) {
                                if (d[0].layout !== 'transform') {
                                    addColorsCount(colors_main, d[1], count);
                                }
                            }
                        } else {
                            addColorsCount(colors_side, d[0], count);
                            if (d.length > 1) {
                                if (d[0].layout !== 'transform') {
                                    addColorsCount(colors_side, d[1], count);
                                }
                            }
                        }
                    });

                    let getCmcArray = (d) => [d.cmc_l, d.cmc_0, d.cmc_1, d.cmc_2, d.cmc_3, d.cmc_4, d.cmc_5, d.cmc_6, d.cmc_7, d.cmc_x];

                    $('#cmc_main').html('<canvas></canvas>');
                    let canvas = $('#cmc_main canvas')[0];
                    canvas.width = 640;
                    canvas.height = 240;

                    new Chart(canvas, {
                        type: 'bar',
                        data: {
                            labels: ['Land', '0', '1', '2', '3', '4', '5', '6', '7+', 'X'],
                            datasets: [
                                {
                                    label: 'Colorless',
                                    data: getCmcArray(colors_main['Colorless']),
                                    backgroundColor: '#E0E0E0',
                                },
                                {
                                    label: 'White',
                                    data: getCmcArray(colors_main['White']),
                                    backgroundColor: '#FFFDDB',
                                },
                                {
                                    label: 'Blue',
                                    data: getCmcArray(colors_main['Blue']),
                                    backgroundColor: '#C8E0F7',
                                },
                                {
                                    label: 'Black',
                                    data: getCmcArray(colors_main['Black']),
                                    backgroundColor: '#D0C7C0',
                                },
                                {
                                    label: 'Red',
                                    data: getCmcArray(colors_main['Red']),
                                    backgroundColor: '#E5B08F',
                                },
                                {
                                    label: 'Green',
                                    data: getCmcArray(colors_main['Green']),
                                    backgroundColor: '#B7D9B5',
                                },
                                {
                                    label: 'Multicolored',
                                    data: getCmcArray(colors_main['Multicolored']),
                                    backgroundColor: '#E5D97C',
                                },
                            ],
                        },
                        options: {
                            responsive: false,
                            plugins: {
                                legend: {
                                    position: 'right',
                                },
                                tooltip: {
                                    bodyAlign: 'right',
                                    footerAlign: 'right',
                                    callbacks: {
                                        footer: (tooltipItem) => {
                                            let sum = tooltipItem.reduce((p, v) => p + v.parsed.y, 0);
                                            return 'Sum: ' + sum;
                                        },
                                    },
                                },
                            },
                            interaction: {
                                intersect: false,
                                mode: 'index',
                            },
                            scales: {
                                x: {
                                    stacked: true,
                                },
                                y: {
                                    stacked: true,
                                },
                            },
                        },
                    });

                    $('#cmc_side').html('<canvas></canvas>');
                    canvas = $('#cmc_side canvas')[0];
                    canvas.width = 640;
                    canvas.height = 240;

                    new Chart(canvas, {
                        type: 'bar',
                        data: {
                            labels: ['Land', '0', '1', '2', '3', '4', '5', '6', '7+', 'X'],
                            datasets: [
                                {
                                    label: 'Colorless',
                                    data: getCmcArray(colors_side['Colorless']),
                                    backgroundColor: '#E0E0E0',
                                },
                                {
                                    label: 'White',
                                    data: getCmcArray(colors_side['White']),
                                    backgroundColor: '#FFFDDB',
                                },
                                {
                                    label: 'Blue',
                                    data: getCmcArray(colors_side['Blue']),
                                    backgroundColor: '#C8E0F7',
                                },
                                {
                                    label: 'Black',
                                    data: getCmcArray(colors_side['Black']),
                                    backgroundColor: '#D0C7C0',
                                },
                                {
                                    label: 'Red',
                                    data: getCmcArray(colors_side['Red']),
                                    backgroundColor: '#E5B08F',
                                },
                                {
                                    label: 'Green',
                                    data: getCmcArray(colors_side['Green']),
                                    backgroundColor: '#B7D9B5',
                                },
                                {
                                    label: 'Multicolored',
                                    data: getCmcArray(colors_side['Multicolored']),
                                    backgroundColor: '#E5D97C',
                                },
                            ],
                        },
                        options: {
                            responsive: false,
                            plugins: {
                                legend: {
                                    position: 'right',
                                },
                                tooltip: {
                                    bodyAlign: 'right',
                                    footerAlign: 'right',
                                    callbacks: {
                                        footer: (tooltipItem) => {
                                            let sum = tooltipItem.reduce((p, v) => p + v.parsed.y, 0);
                                            return 'Sum: ' + sum;
                                        },
                                    },
                                },
                            },
                            interaction: {
                                intersect: false,
                                mode: 'index',
                            },
                            scales: {
                                x: {
                                    stacked: true,
                                },
                                y: {
                                    stacked: true,
                                },
                            },
                        },
                    });
                }

                // type
                {
                    let keys = ['Land', 'Planeswalker', 'Creature', 'Artifact', 'Enchantment', 'Instant', 'Sorcery'];
                    let types_main = {};
                    let types_side = {};
                    keys.forEach(d => {
                        types_main[d] = {
                            front: 0,
                            back: 0,
                        };
                        types_side[d] = {
                            front: 0,
                            back: 0,
                        };
                    });

                    data.forEach((d, i) => {
                        if (d.length === 0) {
                            return;
                        }
                        let count = counts[i];

                        if (sideboard === -1 || i <= sideboard) {
                            keys.forEach(key => {
                                if (d[0].types.includes(key)) {
                                    types_main[key].front += count;
                                }

                                if (d.length > 1) {
                                    if (d[1].types.includes(key)) {
                                        if (!d[0].types.includes('Land') || !d[1].types.includes('Land')) {
                                            types_main[key].back += count;
                                        }
                                    }
                                }
                            });
                        } else {
                            keys.forEach(key => {
                                if (d[0].types.includes(key)) {
                                    types_side[key].front += count;
                                }

                                if (d.length > 1) {
                                    if (d[1].types.includes(key)) {
                                        if (!d[0].types.includes('Land') || !d[1].types.includes('Land')) {
                                            types_side[key].back += count;
                                        }
                                    }
                                }
                            });
                        }
                    });

                    let permanent_spell = types_main['Planeswalker'].front + types_main['Creature'].front + types_main['Artifact'].front + types_main['Enchantment'].front
                        + types_main['Planeswalker'].back + types_main['Creature'].back + types_main['Artifact'].back + types_main['Enchantment'].back;
                    let nonpermanent_spell = types_main['Instant'].front + types_main['Sorcery'].front
                        + types_main['Instant'].back + types_main['Sorcery'].back;

                    let html = '';
                    html += '<table style="border-collapse: collapse">';
                    keys.forEach(key => {
                        html += '<tr>';
                        html += '<td style="text-align: right;">' + (types_main[key].front + types_main[key].back) + '</td>';
                        html += '<td>' + key + '</td>';
                        html += '</tr>';

                        switch (key) {
                            case 'Land':
                            case 'Enchantment':
                                html += '<tr style="border-bottom: ridge;">';
                                html += '</tr>';
                                break;
                        }
                    });
                    html += '<tr style="border-bottom: double;">';
                    html += '</tr>';
                    html += '<tr>';
                    html += '<td>' + permanent_spell + '</td>'
                    html += '<td>Permanent Sepll</td>'
                    html += '</tr>';
                    html += '<tr>';
                    html += '<td>' + permanent_spell + '</td>'
                    html += '<td>Non-permanent Sepll</td>'
                    html += '</tr>';
                    html += '</table>';
                    $('#type_main').html(html);

                    permanent_spell = types_side['Planeswalker'].front + types_side['Creature'].front + types_side['Artifact'].front + types_side['Enchantment'].front
                        + types_side['Planeswalker'].back + types_side['Creature'].back + types_side['Artifact'].back + types_side['Enchantment'].back;
                    nonpermanent_spell = types_side['Instant'].front + types_side['Sorcery'].front
                        + types_side['Instant'].back + types_side['Sorcery'].back;

                    html = '';
                    html += '<table style="border-collapse: collapse">';
                    keys.forEach(key => {
                        html += '<tr>';
                        html += '<td style="text-align: right;">' + (types_side[key].front + types_side[key].back) + '</td>';
                        html += '<td>' + key + '</td>';
                        html += '</tr>';

                        switch (key) {
                            case 'Land':
                            case 'Enchantment':
                                html += '<tr style="border-bottom: ridge;">';
                                html += '</tr>';
                                break;
                        }
                    });
                    html += '<tr style="border-bottom: double;">';
                    html += '</tr>';
                    html += '<tr>';
                    html += '<td>' + permanent_spell + '</td>'
                    html += '<td>Permanent Sepll</td>'
                    html += '</tr>';
                    html += '<tr>';
                    html += '<td>' + permanent_spell + '</td>'
                    html += '<td>Non-permanent Sepll</td>'
                    html += '</tr>';
                    html += '</table>';
                    $('#type_side').html(html);
                }

                // rarity
                {
                    let keys = ['Mythic', 'Rare', 'Uncommon', 'Common'];
                    let raritys_main = {};
                    let raritys_side = {};
                    keys.forEach(key => {
                        raritys_main[key] = 0;
                        raritys_side[key] = 0;
                    });

                    data.forEach((d, i) => {
                        if (d.length === 0) {
                            return;
                        }
                        let count = counts[i];

                        if (sideboard === -1 || i <= sideboard) {
                            raritys_main[d[0].rarity] += count;
                        } else {
                            raritys_side[d[0].rarity] += count;
                        }
                    });

                    let html = '';
                    html += '<table>';
                    keys.forEach(key => {
                        html += '<tr>';
                        html += '<td style="text-align: right;">' + raritys_main[key] + '</td>';
                        html += '<td>' + key + '</td>';
                        html += '</tr>';
                    });
                    html += '</table>';
                    $('#rarity_main').html(html);

                    html = '';
                    html += '<table>';
                    keys.forEach(key => {
                        html += '<tr>';
                        html += '<td style="text-align: right;">' + raritys_side[key] + '</td>';
                        html += '<td>' + key + '</td>';
                        html += '</tr>';
                    });
                    html += '</table>';
                    $('#rarity_side').html(html);
                }

                // set
                {
                    let sets = {};
                    data.forEach((d, i) => {
                        if (d.length === 0) {
                            return;
                        }
                        let count = counts[i];

                        if (!d[0].supertypes.includes('Basic')) {
                            d[0].printings.forEach(d => sets[d] = (sets[d] || 0) + count);
                        }
                    });
                    let keys = Object.keys(sets);
                    keys.sort((a, b) => sets[b] - sets[a]);
                    if (keys.length > 3) {
                        keys.length = 3;
                    }

                    let html = '';
                    html += '<table>';
                    keys.forEach(key => {
                        html += '<tr>';
                        html += '<td style="text-align: right;">' + sets[key] + '</td>';
                        html += '<td>' + key + '</td>';
                        html += '</tr>';
                    });
                    html += '</table>';
                    $('#set').html(html);
                }

                // format
                {
                    let formats = {
                        paper: ['Standard', 'Pioneer', 'Modern', 'Legacy', 'Vintage'],
                        paper_p: ['Pauper'],
                        arena: ['Alchemy', 'Historic'],
                        brawl: ['Brawl', 'Historicbrawl', 'Commander'],
                        brawl_p: ['Paupercommander'],
                    };
                    let standard = {
                        m18: true,
                        m19: true,
                        m20: true,
                        m21: true,
                    };
                    data.forEach((d, i) => {
                        if (d.length === 0) {
                            return;
                        }
                        let legalities = d[0].legalities.map(d => d.format);
                        formats.paper = formats.paper.filter(d => legalities.includes(d));
                        formats.paper_p = formats.paper_p.filter(d => legalities.includes(d));
                        formats.arena = formats.arena.filter(d => legalities.includes(d));
                        formats.brawl = formats.brawl.filter(d => legalities.includes(d));
                        formats.brawl_p = formats.brawl_p.filter(d => legalities.includes(d));

                        if (!['KLD', 'AER', 'AKH', 'HOU', 'XLN', 'RIX', 'DOM', 'M19'].some(set => d[0].printings.includes(set))) {
                            standard.m18 = false;
                        }
                        if (!['XLN', 'RIX', 'DOM', 'M19', 'GRN', 'RNA', 'WAR', 'M20'].some(set => d[0].printings.includes(set))) {
                            standard.m19 = false;
                        }
                        if (!['GRN', 'RNA', 'WAR', 'M20', 'ELD', 'THB', 'IKO', 'M21'].some(set => d[0].printings.includes(set))) {
                            standard.m20 = false;
                        }
                        if (!['ELD', 'THB', 'IKO', 'M21', 'ZNR', 'KHM', 'STX', 'AFR'].some(set => d[0].printings.includes(set))) {
                            standard.m21 = false;
                        }
                    });

                    let html = '';
                    html += '<table>';
                    if (commander) {
                        let format_names = {
                            Brawl: 'Standard-Brawl',
                            Historicbrawl: 'Historic-Brawl',
                            Commander: 'Commander',
                            Paupercommander: 'Pauper-Commander',
                        };

                        if (formats.brawl_p.length > 0) {
                            formats.brawl_p.forEach(d => {
                                html += '<tr>';
                                html += '<td>' + format_names[d] + '</td>';
                                html += '</tr>';
                            });
                        } else {
                            formats.brawl.forEach(d => {
                                html += '<tr>';
                                html += '<td>' + format_names[d] + '</td>';
                                html += '</tr>';
                            });
                        }
                    } else {
                        if (formats.paper_p.length > 0) {
                            html += '<tr>';
                            formats.paper_p.forEach(d => {
                                html += '<td>' + d + '</td>';
                            });
                            html += '</tr>';
                        } else {
                            html += '<tr>';
                            formats.paper.forEach(d => {
                                html += '<td>' + d + '</td>';
                            });
                            html += '</tr>';
                            html += '<tr>';
                            formats.arena.forEach(d => {
                                html += '<td>' + d + '</td>';
                            });
                            html += '</tr>';
                        }
                    }
                    if (standard.m18) {
                        html += '<tr>';
                        html += '<td colspan="20">(M18 Standard)</td>';
                        html += '</tr>';
                    }
                    if (standard.m19) {
                        html += '<tr>';
                        html += '<td colspan="20">(M19 Standard)</td>';
                        html += '</tr>';
                    }
                    if (standard.m20) {
                        html += '<tr>';
                        html += '<td colspan="20">(M20 Standard)</td>';
                        html += '</tr>';
                    }
                    if (standard.m21) {
                        html += '<tr>';
                        html += '<td colspan="20">(M21 Standard)</td>';
                        html += '</tr>';
                    }
                    html += '</table>';
                    $('#format').html(html);
                }

                // keycard
                {
                    let keymap = {
                        'Arclight Phoenix': 'Phoenix',
                        'Bolas\'s Citadel': 'Citadel',
                        'Casualties of War': 'Casualties',
                        'Cavalcade of Calamity': 'Cavalcade',
                        'Command the Dreadhorde': 'Dreadhorde',
                        'Crackling Drake': 'Drake',
                        'Doom Foretold': 'Doom',
                        'Embercleave': 'Embercleave',
                        'Experimental Frenzy': 'Frenzy',
                        'Feather, the Redeemed': 'Feather',
                        'Feasting Troll King': 'Troll King',
                        'Field of the Dead': 'Field',
                        'Fires of Invention': 'Fires',
                        'Flood of Tears': 'Tears',
                        'Ghalta, Primal Hunger': 'Ghalta',
                        'Goldspan Dragon': 'Dragon',
                        'Golos, Tireless Pilgrim': 'Golos',
                        'Happily Ever After': 'Happily Ever After',
                        'Hero of Precinct One': 'Hero',
                        'Irencrag Pyromancer': 'Irencrag',
                        'Lich\'s Mastery': 'Lich',
                        'March of the Multitudes': 'March',
                        'Nicol Bolas, Dragon-God': 'Bolas',
                        'Nine Lives': 'Nine Lives',
                        'Nissa, Who Shakes the World': 'Nissa',
                        'Oko, Thief of Crowns': 'Oko',
                        'Sephara, Sky\'s Blade': 'Sephara',
                        'Scapeshift': 'Scapeshift',
                        'Tibalt\'s Trickery': 'Tibalt\'s Trickery',
                        'Yorvo, Lord of Garenbrig': 'Yorvo',
                        'Wilderness Reclamation': 'Reclamation',
                    };
                    let keycount = {};

                    let keycards = [];
                    data.forEach((d, i) => {
                        if (d.length === 0) {
                            return;
                        }
                        let count = counts[i] + (keycount[d[0].name] || 0);
                        keycount[d[0].name] = count;

                        if (commander) {
                            if (i === 0) {
                                keycards.push(d[0].name);
                            }
                        } else {
                            if (count === 4) {
                                if (d[0].name in keymap) {
                                    keycards.push(keymap[d[0].name]);
                                }
                            }
                        }
                    });

                    let html = '';
                    html += '<table>';
                    keycards.forEach(d => {
                        html += '<tr>';
                        html += '<td>' + d + '</td>';
                        html += '</tr>';
                    });
                    html += '</table>';
                    $('#keycard').html(html);
                }

                // decktype / subtype / keyword / archetype
                {
                    let archetype_counts = {
                        gate: 0,
                        gate_cards: [],

                        elemental: 0,
                        elemental_cards: [],
                        human: 0,
                        human_cards: [],
                        knight: 0,
                        knight_cards: [],
                        vampire: 0,
                        vampire_cards: [],
                        wolf: 0,
                        wolf_cards: [],
                        zombie: 0,
                        zombie_cards: [],

                        adventure: 0,
                        adventure_cards: [],

                        food: 0,
                        food_cards: [],

                        explore: 0,
                        explore_cards: [],
                        flying: 0,
                        flying_cards: [],
                        heroic: 0,
                        heroci_cards: [],
                        mentor: 0,
                        mentor_cards: [],
                        sacrifice: 0,
                        sacrifice_cards: [],
                        second_draw: 0,
                        second_draw_cards: [],

                        artifact: 0,
                        artifact_cards: [],
                        planeswalker: 0,
                        planeswalker_cards: [],
                        permission: 0,
                        permission_cards: [],
                        spells: 0,
                        spells_cards: [],
                        mana_acceleration: 0,
                        mana_acceleration_cards: [],
                        instant: 0,
                        instant_cards: [],
                        token: 0,
                        token_cards: [],
                        creature: 0,
                        creature_cards: [],
                        weenie: 0,
                        weenie_cards: [],
                        direct_damage: 0,
                        direct_damage_cards: [],
                        reanimate: 0,
                        reanimate_cards: [],
                        wrath: 0,
                        wrath_cards: [],
                    };
                    data.forEach((d, i) => {
                        if (d.length === 0) {
                            return;
                        }
                        let count = counts[i];

                        let type_temp = '';
                        let text_temp = '';
                        if (!d[0].types.includes('Land')) {
                            type_temp += d[0].type;
                            text_temp += d[0].text;
                        }
                        if (d.length > 1) {
                            if (!d[1].types.includes('Land')) {
                                type_temp += ' ' + d[1].type;
                                text_temp += ' ' + d[1].text;
                            }
                        }

                        text_temp = text_temp.split(d[0].name).join('.');
                        if (d.length > 1) {
                            text_temp = text_temp.split(d[1].name).join('.');
                        }

                        type_temp = type_temp.toLowerCase();
                        text_temp = text_temp.toLowerCase();

                        // subtype land
                        if (type_temp.includes('gate') || text_temp.includes('gate')) {
                            archetype_counts.gate += count;
                            archetype_counts.gate_cards.push(d[0]);
                        }

                        // subtype creature
                        let creature_type = false;
                        if (text_temp.includes('changeling') || text_temp.includes('choose a creature type')) {
                            creature_type = true;
                        }
                        if (creature_type || type_temp.includes('elemental') || text_temp.includes('elemental')) {
                            archetype_counts.elemental += count;
                            archetype_counts.elemental_cards.push(d[0]);
                        }
                        if (creature_type || type_temp.includes('human') || text_temp.includes('human')) {
                            archetype_counts.human += count;
                            archetype_counts.human_cards.push(d[0]);
                        }
                        if (creature_type || type_temp.includes('knight') || text_temp.includes('knight')) {
                            archetype_counts.knight += count;
                            archetype_counts.knight_cards.push(d[0]);
                        }
                        if (creature_type || type_temp.includes('vampire') || text_temp.includes('vampire')) {
                            archetype_counts.vampire += count;
                            archetype_counts.vampire_cards.push(d[0]);
                        }
                        if (creature_type || type_temp.includes('wolf') || text_temp.includes('wolf') || text_temp.includes('wolves')) {
                            archetype_counts.wolf += count;
                            archetype_counts.wolf_cards.push(d[0]);
                        }
                        if (creature_type || type_temp.includes('zombie') || text_temp.includes('zombie')) {
                            archetype_counts.zombie += count;
                            archetype_counts.zombie_cards.push(d[0]);
                        }

                        if (creature_type || type_temp.includes('adventure') || text_temp.includes('adventure')) {
                            archetype_counts.adventure += count;
                            archetype_counts.adventure_cards.push(d[0]);
                        }

                        // subtype artifact
                        if (creature_type || type_temp.includes('food') || text_temp.includes('food')) {
                            archetype_counts.food += count;
                            archetype_counts.food_cards.push(d[0]);
                        }

                        // keyword
                        if (text_temp.includes('explores')) {
                            archetype_counts.explore += count;
                            archetype_counts.explore_cards.push(d[0]);
                        }
                        if (text_temp.includes('flying')) {
                            archetype_counts.flying += count;
                            archetype_counts.flying_cards.push(d[0]);
                        }
                        if (text_temp.includes('heroic')
                            || (text_temp.includes('whenever you cast') && text_temp.includes('that targets'))
                            || text_temp.includes('becomes the target of a spell you control')) {
                            archetype_counts.heroic += count;
                            archetype_counts.heroci_cards.push(d[0]);
                        }
                        if (text_temp.includes('mentor')) {
                            archetype_counts.mentor += count;
                            archetype_counts.mentor_cards.push(d[0]);
                        }
                        if (text_temp.includes('sacrifice')) {
                            archetype_counts.sacrifice += count;
                            archetype_counts.sacrifice_cards.push(d[0]);
                        }
                        if (text_temp.includes('whenever you draw your second card each turn')) {
                            archetype_counts.second_draw += count;
                            archetype_counts.second_draw_cards.push(d[0]);
                        }

                        // decktype
                        if (type_temp.includes('artifact') || text_temp.includes('artifact creature token')) {
                            archetype_counts.artifact += count;
                            archetype_counts.artifact_cards.push(d[0]);
                        }
                        if (type_temp.includes('planeswalker') || text_temp.includes('planeswalker token')) {
                            archetype_counts.planeswalker += count;
                            archetype_counts.planeswalker_cards.push(d[0]);
                        }
                        if (text_temp.includes('counter target') || text_temp.includes('counter that') || text_temp.includes('counter it')
                            || text_temp.includes('return target spell') || text_temp.includes('put target spell') || text_temp.includes('choose target spell') || text_temp.includes('owner of target spell')
                            || ((type_temp.includes('instant') || text_temp.includes('flash')) && (text_temp.includes('hexproof') || text_temp.includes('protection')))) {
                            archetype_counts.permission += count;
                            archetype_counts.permission_cards.push(d[0]);
                        }
                        if (type_temp.includes('instant') || type_temp.includes('sorcery')) {
                            archetype_counts.spells += count;
                            archetype_counts.spells_cards.push(d[0]);
                        }
                        if (text_temp.includes('add {')
                            || (text_temp.includes('add ') && text_temp.includes('mana'))
                            || ((text_temp.includes(' land') || text_temp.includes('forest')) && text_temp.includes('put'))
                            || (text_temp.includes('play') && text_temp.includes('additional land'))) {
                            archetype_counts.mana_acceleration += count;
                            archetype_counts.mana_acceleration_cards.push(d[0]);
                        }
                        if (type_temp.includes('instant') || text_temp.includes('flash')) {
                            archetype_counts.instant += count;
                            archetype_counts.instant_cards.push(d[0]);
                        }
                        if (text_temp.includes('creature token')) {
                            archetype_counts.token += count;
                            archetype_counts.token_cards.push(d[0]);
                        }
                        if (type_temp.includes('creature') || text_temp.includes('creature token')
                            || (text_temp.includes('land') && text_temp.includes('become') && text_temp.includes('creature'))) {
                            archetype_counts.creature += count;
                            archetype_counts.creature_cards.push(d[0]);
                            if (d[0].cmc < 3) {
                                archetype_counts.weenie += count;
                                archetype_counts.weenie_cards.push(d[0]);
                            }
                        }
                        if ((text_temp.includes('deals') && (text_temp.includes('any target') || text_temp.includes('player') || text_temp.includes('opponent')))
                            || ((text_temp.includes('player loses') || text_temp.includes('opponent loses')) && text_temp.includes('life'))) {
                            archetype_counts.direct_damage += count;
                            archetype_counts.direct_damage_cards.push(d[0]);
                        }
                        if (text_temp.includes('graveyard to the battlefield')
                            || (text_temp.includes('graveyard') && text_temp.includes('onto the battlefield under your control'))) {
                            archetype_counts.reanimate += count;
                            archetype_counts.reanimate_cards.push(d[0]);
                        }
                        if (text_temp.includes('destroy all') || text_temp.includes('destroy each')
                            || text_temp.includes('exile all') || text_temp.includes('exile each')
                            || text_temp.includes('return all')
                            || text_temp.includes('sacrifices the rest')
                            || (text_temp.includes('each creature') || text_temp.includes('creatures') || text_temp.includes('creature tokens')) && (text_temp.includes('get -') || text_temp.includes('gets -'))
                            || (text_temp.includes('deals') && text_temp.includes('each creature'))) {
                            archetype_counts.wrath += count;
                            archetype_counts.wrath_cards.push(d[0]);
                        }
                    });
                    console.log(archetype_counts);

                    // subtype
                    let html = '';
                    html += '<table>';
                    if (archetype_counts.gate / counts_sum >= 0.16) {
                        html += '<tr>';
                        html += '<td>Gate</td>';
                        html += '</tr>';
                    }

                    if (archetype_counts.elemental / counts_sum >= 0.26) {
                        html += '<tr>';
                        html += '<td>Elemental</td>';
                        html += '</tr>';
                    }
                    if (archetype_counts.human / counts_sum >= 0.26) {
                        html += '<tr>';
                        html += '<td>Human</td>';
                        html += '</tr>';
                    }
                    if (archetype_counts.knight / counts_sum >= 0.26) {
                        html += '<tr>';
                        html += '<td>Knight</td>';
                        html += '</tr>';
                    }
                    if (archetype_counts.vampire / counts_sum >= 0.26) {
                        html += '<tr>';
                        html += '<td>Vampire</td>';
                        html += '</tr>';
                    }
                    if (archetype_counts.wolf / counts_sum >= 0.26) {
                        html += '<tr>';
                        html += '<td>Wolf</td>';
                        html += '</tr>';
                    }
                    if (archetype_counts.zombie / counts_sum >= 0.26) {
                        html += '<tr>';
                        html += '<td>Zombie</td>';
                        html += '</tr>';
                    }

                    if (archetype_counts.adventure / counts_sum >= 0.21) {
                        html += '<tr>';
                        html += '<td>Adventure</td>';
                        html += '</tr>';
                    }

                    if (archetype_counts.food / counts_sum >= 0.16) {
                        html += '<tr>';
                        html += '<td>Food</td>';
                        html += '</tr>';
                    }
                    html += '</table>';
                    $('#subtype').html(html);

                    // keyword
                    html = '';
                    html += '<table>';
                    if (archetype_counts.explore / counts_sum >= 0.16) {
                        html += '<tr>';
                        html += '<td>Explore</td>';
                        html += '</tr>';
                    }
                    if (archetype_counts.flying / counts_sum >= 0.26) {
                        html += '<tr>';
                        html += '<td>Flyer</td>';
                        html += '</tr>';
                    }
                    if (archetype_counts.heroic / counts_sum >= 0.10) {
                        html += '<tr>';
                        html += '<td>Heroic</td>';
                        html += '</tr>';
                    }
                    if (archetype_counts.mentor / counts_sum >= 0.23) {
                        html += '<tr>';
                        html += '<td>Mentor</td>';
                        html += '</tr>';
                    }
                    if (archetype_counts.sacrifice / counts_sum >= 0.24) {
                        html += '<tr>';
                        html += '<td>Sacrifice</td>';
                        html += '</tr>';
                    }
                    if (archetype_counts.second_draw / counts_sum >= 0.09) {
                        html += '<tr>';
                        html += '<td>Second Draw</td>';
                        html += '</tr>';
                    }
                    html += '</table>';
                    $('#keyword').html(html);

                    // archetype
                    html = '';
                    html += '<table>';
                    let archetypes = [];
                    if (archetype_counts.artifact / counts_sum >= 0.32) {
                        archetypes.push('artifact');
                        html += '<tr>';
                        html += '<td>Artifact</td>';
                        html += '</tr>';
                    }
                    if (archetype_counts.planeswalker / counts_sum >= 0.21) {
                        archetypes.push('planeswalker');
                        html += '<tr>';
                        html += '<td>Superfriends</td>';
                        html += '</tr>';
                    }
                    if (archetype_counts.permission / counts_sum >= 0.26) {
                        archetypes.push('permission');
                        html += '<tr>';
                        html += '<td>Permission</td>';
                        html += '</tr>';
                    }
                    if (archetype_counts.spells / counts_sum >= 0.32) {
                        archetypes.push('spells');
                        html += '<tr>';
                        html += '<td>Spells</td>';
                        html += '</tr>';
                    }
                    if (archetype_counts.mana_acceleration / counts_sum >= 0.21) {
                        archetypes.push('mana_acceleration');
                        html += '<tr>';
                        html += '<td>Ramp</td>';
                        html += '</tr>';
                    }
                    if (archetype_counts.instant / counts_sum >= 0.32) {
                        archetypes.push('instant');
                        html += '<tr>';
                        html += '<td>Flash</td>';
                        html += '</tr>';
                    }
                    if (archetype_counts.token / counts_sum >= 0.23) {
                        archetypes.push('token');
                        html += '<tr>';
                        html += '<td>Token</td>';
                        html += '</tr>';
                    }
                    if (archetype_counts.creature / counts_sum >= 0.32) {
                        archetypes.push('creature');
                        html += '<tr>';
                        html += '<td>Beatdown</td>';
                        html += '</tr>';
                    }
                    if (archetype_counts.direct_damage / counts_sum >= 0.32) {
                        archetypes.push('direct_damage');
                        html += '<tr>';
                        html += '<td>Burn</td>';
                        html += '</tr>';
                    }
                    if (archetype_counts.reanimate / counts_sum >= 0.10) {
                        archetypes.push('reanimate');
                        html += '<tr>';
                        html += '<td>Reanimate</td>';
                        html += '</tr>';
                    }
                    if (archetype_counts.wrath / counts_sum >= 0.05) {
                        archetypes.push('wrath');
                        html += '<tr>';
                        html += '<td>Control</td>';
                        html += '</tr>';
                    }
                    html += '</table>';
                    $('#archetype').html(html);

                    // decktype
                    let decktype = '???';
                    if (archetypes.includes('creature')) {
                        if (archetypes.includes('wrath')) {
                            decktype = 'Midrange';
                        } else if (archetypes.includes('permission')) {
                            decktype = 'Clock Permission';
                        } else if (archetypes.includes('mana_acceleration')) {
                            decktype = 'Stompy';
                        } else if (archetypes.includes('direct_damage')) {
                            decktype = 'Sligh';
                        } else if (archetype_counts.weenie / counts_sum >= 0.26) {
                            decktype = 'Weenie';
                        } else {
                            decktype = 'Aggro';
                        }
                    } else if (archetypes.includes('mana_acceleration')) {
                        decktype = 'Ramp';
                    } else if (archetypes.includes('wrath')) {
                        decktype = 'Control';
                    } else {
                        decktype = 'Combo';
                    }
                    $('#decktype').html(decktype);
                }

                // image
                {
                    let html = '';
                    data.forEach((d, i) => {
                        if (i !== 0 && empty_row.includes(i)) {
                            html += '<hr style="height: 2px; background: #000000;">';
                        }
                        if (d.length === 0) {
                            return;
                        }
                        let count = counts[i];

                        html += '<div style="display: inline-block; position: relative;">';
                        html += '<img style="position: absolute; z-index: -1; margin: 0; background: #E7E9EB;" alt="" src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=">';

                        html += '<div class="front">';
                        html += '<p style="position: absolute; z-index: -1; margin: 4px; width: calc(100% - 8px); word-wrap: break-word;">' + d[0].name + '</p>';
                        html += '<img alt="" src="' + d[0].imageUrl + '" onerror="this.style.visibility = \'hidden\'">';
                        html += '</div>';
                        if (d.length > 1) {
                            if (d[0].imageUrl !== d[1].imageUrl) {
                                html += '<div class="back" style="display: none;">';
                                html += '<p style="position: absolute; z-index: -1; margin: 4px; width: calc(100% - 8px); word-wrap: break-word;">' + d[1].name + '</p>';
                                html += '<img alt="" src="' + d[1].imageUrl + '" onerror="this.style.visibility = \'hidden\'">';
                                html += '</div>';

                                html += '<span class="flip material-symbols-outlined" style="position: absolute; bottom: 0; left: calc(50% - 12px); border-radius: 50%; background: white; cursor: pointer;">sync</span>';
                            }
                        }
                        html += '<p style="position: absolute; bottom: 8px; margin: 8px; border-radius: 4px; width: 20%; font-weight: bold; text-align: center; background: white;">' + count + '</p>';
                        html += '</div>';
                    });
                    $('#board')
                        .html(html)
                        .on('click', '.flip', e => {
                            let target = $(e.target);
                            let back = target.prev();
                            let front = back.prev();

                            back.toggle();
                            front.toggle();
                        });

                    resizeImage();
                }
            });
        }

        function send(set, number) {
            return new Promise((resolve, reject) => {
                let request = new XMLHttpRequest();
                request.open('GET', 'https://api.magicthegathering.io/v1/cards?set=' + set + '&number=' + number);
                request.onload = () => {
                    let data = JSON.parse(request.response);
                    resolve(data.cards);
                };
                request.onerror = () => {
                    reject();
                }
                request.send();
            });
        }
    </script>
</body>

</html>